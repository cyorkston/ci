<project name="CI" basedir="." xmlns:sf="antlib:com.salesforce">
	
  <property name="src.dir" value="../src" />
	<property name="build.lib.dir" value="./lib/" />
  <property file="./build.properties"/>
  <property environment="env"/>
	<property name="sf.destructiveChanges" value="false"/>
	
  <!-- Build targets -->
  <target name="buildCI" depends="initCheckOnly, initCI, deployPackaged" />
	
	<target name="initCheckOnly">
			<condition property="sf.checkOnly" value="false" else="true">
			<and>
				<equals arg1="${env.checkOnly}" arg2="false"/>
				<isset property="env.checkOnly"/>
			</and>
		</condition>
	</target>
	
  <target name="initCI">
		<property name="sf.username" value="${sf.ci.username}"/>
		<property name="sf.password" value="${sf.ci.password}"/>
  	<property name="sf.token" value="${sf.ci.token}"/>
		<property name="sf.serverurl" value="${sf.ci.serverurl}"/>
  </target>
	
  <target name="cleanAfter" depends="deployPackaged">
    <echo level="info">Clean Down Workspace Ready for Next Build</echo>
    <delete dir="${src.dir}" failonerror="false" />
    <delete includeEmptyDirs="true" failonerror="false">
      <fileset dir="${src.dir}"/>
    </delete>
  </target>
  
  <path id="classpath4">
  	<!--
    <fileset dir="/usr/local/apache-ant-1.9.2/lib" />
    -->
  	<fileset dir="${build.lib.dir}" />
  </path>

  <target name="deployPackaged">
    <echo message="deploying from metadata" />
    <echo message="serverurl=${sf.serverurl}" />
    <echo message="username=${sf.username}" />
  	<echo message="env.checkOnly=${env.checkOnly}"/>
    <echo message="sf.checkOnly=${sf.checkOnly}" />
    <echo message="destructiveChanges=${sf.destructiveChanges}" />
    <echo message="ANT_HOME=${ant.home}"/>
    <echo message="BASEDIR=${basedir}"/>
    <echo message="ANT_CORE_LIB=${ant.core.lib}"/>
    <echo message="JAVA_VERSION=${ant.java.version}"/>
    <echo message="ANT_LIBRARY_DIR=${ant.library.dir}"/>
    <echo message="classpath=${java.class.path}"/>
  	<echo message="sf.pkgContents=${sf.pkgContents}"/>
    
    <taskdef name="sfdeploy" classname="com.claimvantage.force.ant.DeployWithXmlReportTask" classpathref="classpath4"/>

    <zip destfile="${src.dir}/batch.zip" basedir="${src.dir}" includes="${sf.pkgContents}" />
    
    <sfdeploy
			username="${sf.username}" 
			password="${sf.password}${sf.token}" 
			serverurl="${sf.serverurl}" 
			maxPoll="${sf.maxPoll}" pollWaitMillis="${sf.maxWaitMillis}" 
			zipFile="${src.dir}/batch.zip" 
    	checkOnly="${sf.checkOnly}" 
			runalltests="false" 
			junitreportdir="test-report-xml"
		>
		
		<!-- Run all tests that match the include file name pattern (so avoiding running managed package tests) -->
			<batchtest>
				<fileset dir="${src.dir}/classes">
					<include name="*Test*.cls"/>
				</fileset>
			</batchtest>
		</sfdeploy>

  </target>
	
</project>
